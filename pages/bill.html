<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bill</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Firebase App (for Firebase features) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js"></script> -->
    <!-- Firebase Firestore and Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="./bil.css">
</head>

<body>
    <div class="homeContainer">
        <div id="customAlert" style="
    display: none; 
    position: fixed; 
    top: 20px; 
    left: 50%; 
    transform: translateX(-50%);
    background-color: #3978de; 
    color: white; 
    padding: 10px 20px; 
    border-radius: 5px; 
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
    font-size: 14px; 
    z-index: 1000;">
        </div>
        <!-- Fixed billRow -->

        <div class=" billrow">
            <img width="30px" height="30px" src="./icons/back.png" alt="" id="navigate">
            <h2 class="ms-4">Bill</h2>
        </div>
        <div class="homeBody">
            <!-- Form to add a new product -->

            <div class="billBox">
                <div class="form-container " id="billForm">
                    <div class=" inputDiv">
                        <div>
                            <label for="customerName" class="form-label">Customer Name :</label>
                            <input type="text" class="form-control input" id="customerNameName"
                                placeholder="Enter Customer Name" required>
                        </div>

                        <div>
                            <label for="phoneNumber" class="form-label">Phone Number :</label>
                            <input type="tel" class="form-control input" id="phoneNumber"
                                placeholder="Enter Phone Number" maxlength="10" required>
                        </div>

                    </div>


                    <div class="inputDiv">
                        <div>
                            <label for="dateField" class="form-label">Select Date:</label>
                            <input type="text" id="dateField" class="form-control input" readonly
                                placeholder="dd-mm-yyyy" required>

                        </div>

                        <div>
                            <label for="transactionType" class="form-label">Transaction Type:</label>
                            <select id="transactionType" class="form-control input" required>
                                <option value="credit">Credit</option>
                                <option value="Full Payment">Full Payment</option>


                            </select>
                        </div>
                    </div>
                    <div class="inputDiv">


                        <div>
                            <label for="transactionMode" class="form-label">Transaction Mode:</label>
                            <select id="transactionMode" class="form-control input" required>
                                <option value="cash">Cash</option>
                                <option value="UPI">UPI</option>


                            </select>
                        </div>
                    </div>




                    <div class="mt-3 d-flex align-items-center ">
                        <label for="addItemButton" class="form-label  ">Add items :</label>
                        <!-- <button id="addItemButton" class="btn btn-primary ms-3 mb-3 text-center">Add Item</button> -->
                    </div>


                    <table class="table table-bordered" id="itemTable">
                        <thead>
                            <tr>
                                <th>S/N</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be dynamically added here -->
                        </tbody>
                    </table>
                </div>



                <div class="save  " id="save" style="display: none;">

                    <div class="TOTAL">
                        Total : <span id="total"></span>
                    </div>
                    <div class="print ms-3 me-2" id="save">save</div>
                </div>

                <div class=" save cerditsave" id="credit" style="display: flex;">



                </div>


                <!-- table -->


            </div>


            <div class="valuesContainer" id="values">
                <div class="values">
                    <div id="creditFields" class="gap-0  ">
                        <div>
                            <label for="initialPayment" class="form-label">Paying Amount:</label>
                            <input type="number" id="initialPayment" class="form-control"
                                placeholder="Enter paying Amount">

                        </div>

                    </div>
                </div>
                <div class="values">
                    <div class="credTotal">Total : <span id="credtotal"></span> </div>
                </div>
                <div class="values">
                    <div class="TOTAL">
                        Balance : <span id="balanceAmount"></span>
                    </div>
                </div>
                <div class="values">
                    <div class="print " id="creditsave">Save & Print</div>
                </div>

            </div>


        </div>

        <!-- firebase -->
        <script type="module">
            // Firebase imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
            import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyC3juw1BAUqD8Br89PmtjTwVvl1U-M_wO4",
                authDomain: "shami-b33d8.firebaseapp.com",
                projectId: "shami-b33d8",
                storageBucket: "shami-b33d8.firebasestorage.app",
                messagingSenderId: "608430710016",
                appId: "1:608430710016:web:4bfdd719fa3b4999cea7e5"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // Validation and saving logic
            window.validateAndSaveTransaction = async function validateAndSaveTransaction() {
                try {
                    // Perform validation
                    const customerName = document.getElementById("customerNameName").value.trim();
                    const phoneNumber = document.getElementById("phoneNumber").value.trim();
                    const date = document.getElementById("dateField").value.trim();
                    const transactionType = document.getElementById("transactionType").value;
                    const transactionMode = document.getElementById("transactionMode").value;
                    const initialPayment = document.getElementById("initialPayment").value;
                    const totalAmount = parseFloat(document.getElementById("credtotal").textContent || "0");
                    const balanceAmount = parseFloat(document.getElementById("balanceAmount").textContent || "0");




                    if (!customerName) {
                        showAlert("Customer name is required.", 2500);
                        return;
                    }

                    // Check if customer name already exists in Firestore
                    const billsRef = collection(db, "bills");
                    // const customerQuery = query(billsRef, where("customerName", "==", customerName));
                    // const querySnapshot = await getDocs(customerQuery);

                    // if (!querySnapshot.empty) {
                    //     // Customer name already exists in Firestore
                    //     showAlert("Customer name already exists.", 2500);
                    //     return;
                    // }

                    if (!phoneNumber || isNaN(phoneNumber) || phoneNumber.length !== 10) {
                        showAlert("Please enter a valid 10-digit phone number.", 2500);
                        return;
                    }

                    if (!date) {
                        showAlert("Please select a date.", 2500);
                        return;
                    }

                    if (!transactionType) {
                        showAlert("Please select a transaction type.", 2500);
                        return;
                    }

                    const table = document.getElementById("itemTable").querySelector("tbody");
                    if (!table || table.rows.length === 0) {
                        showAlert("Please add at least one item to the table.", 2500);
                        return;
                    }
                    if (initialPayment == totalAmount && transactionType === "credit") {
                        showAlert("change Transaction Type", 2500)
                        return
                    }

                    // Check each row for completeness (Item Name, Unit Price, Quantity, Amount)
                    for (let i = 0; i < table.rows.length; i++) {
                        const cells = table.rows[i].querySelectorAll("td");

                        // Validate each required field in the row
                        const itemName = cells[1]?.querySelector('input')?.value.trim();
                        // const unitPrice = parseFloat(cells[2]?.querySelector('input')?.value.trim() || "0");
                        // const quantity = parseInt(cells[3]?.querySelector('input')?.value.trim() || "0");
                        const amount = parseFloat(cells[2]?.querySelector('input')?.value.trim() || "0");

                        // Check if fields are empty or invalid
                        if (!itemName) {
                            showAlert(`Please enter Item Name for row ${i + 1}.`, 2500);
                            return;
                        }

                        if (isNaN(amount) || amount <= 0) {
                            showAlert(`Please enter a valid Amount for row ${i + 1}.`, 2500);
                            return;
                        }
                    }

                    // If all validation passes, proceed with saving the transaction
                    await window.saveCreditTransaction();
                    // Call pdfload after saving to Firestore
                } catch (error) {
                    console.error("Error during validation and save:", error);
                }
            };

            window.saveCreditTransaction = async function saveCreditTransaction() {
                try {
                    // Step 1: Count the number of documents in the "bills" collection
                    const billsCollectionRef = collection(db, "bills");
                    const billsSnapshot = await getDocs(billsCollectionRef);

                    // Generate a new invoice number based on the document count
                    const newInvoiceNo = billsSnapshot.size + 1; // `size` gives the number of documents
                    const formattedInvoiceNo = `INV-${String(newInvoiceNo).padStart(3, '0')}`; // Format as INV-001, INV-002, etc.

                    // Step 2: Collect customer and transaction details
                    const customerName = document.getElementById("customerNameName").value;
                    const phoneNumber = document.getElementById("phoneNumber").value;
                    const date = document.getElementById("dateField").value;
                    const transactionType = document.getElementById("transactionType").value;
                    const transactionMode = document.getElementById("transactionMode").value;

                    const rows = document.querySelectorAll('#itemTable tbody tr');
                    const items = Array.from(rows).map((row) => {
                        const cells = row.querySelectorAll('td');
                        const itemName = cells[1].querySelector('input') ? cells[1].querySelector('input').value : cells[1].textContent;
                        const amount = cells[2].querySelector('input') ? cells[2].querySelector('input').value : cells[2].textContent;
                        return { itemName, amount };
                    });

                    const totalAmount = parseFloat(document.getElementById("total").textContent || "0");
                    const initialPayment = parseFloat(document.getElementById("initialPayment").value || "0");
                    const balanceAmount = parseFloat(document.getElementById("balanceAmount").textContent || "0");

                    const currentDateTime = new Date().toLocaleString();

                    const transactionHistory = [
                        {
                            paidAmount: initialPayment,
                            timestamp: currentDateTime
                        }
                    ];

                    // Step 3: Prepare data for Firestore
                    const data = {
                        invoiceNo: formattedInvoiceNo, // Use the formatted invoice number
                        customerName,
                        phoneNumber,
                        date,
                        transactionType,
                        transactionMode,
                        items,
                        totalAmount,
                        initialPayment,
                        balanceAmount,
                        transactionHistory
                    };

                    // Step 4: Save the new invoice document to the `bills` collection
                    const docRef = await addDoc(billsCollectionRef, data);

                    console.log("Transaction saved successfully with Invoice No:", formattedInvoiceNo);
                    window.InvoiceNo = formattedInvoiceNo;
                    window.customerName = customerName;
                    window.date = date;
                    window.pdfload();
                    // location.reload();




                } catch (error) {
                    console.error("Error saving data: ", error);
                    alert("Contact Code 114. @ 9526718126");
                }
            };

        </script>

        <script>
            const showAlert = (message, duration = 3000) => {
                const alertBox = document.getElementById("customAlert");
                alertBox.textContent = message;
                alertBox.style.display = "block";

                // Hide the alert after the specified duration
                setTimeout(() => {
                    alertBox.style.display = "none";
                }, duration);
            };
            const navigate = document.getElementById("navigate");
            navigate.addEventListener("click", () => {
                window.location.href = './homePage.html';  // This will navigate to the homepage
            });

            // Attach the validation and saving logic to the save button
            document.getElementById("creditsave").addEventListener("click", () => {
                window.validateAndSaveTransaction();
            });
        </script>



        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

        <script>


            // validate

            function pdfload() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;

                // Define margins
                const margin = 10;

                // Variables to display
                const invoiceNo = window.InvoiceNo || "N/A";
                const date = window.date || "N/A";
                const customerName = window.customerName || "N/A";

                // Draw a border around the whole page
                pdf.setDrawColor(0);
                pdf.setLineWidth(0.5);
                pdf.rect(margin, margin, pageWidth - 2 * margin, pageHeight - 2 * margin);

                // Header Section
                const headerHeight = (pageHeight - 2 * margin) * 0.3;
                const totalWidth = pageWidth - 2 * margin;
                const width60 = totalWidth * 0.6;

                let currentY = margin;

                // Header Title: "INVOICE BILL"
                pdf.setFillColor(0, 0, 139); // Dark blue background
                pdf.rect(margin, currentY, width60, 12, 'F');
                pdf.setTextColor(255, 255, 255); // White text
                pdf.setFontSize(14);
                pdf.text("INVOICE BILL", margin + width60 / 2, currentY + 8, { align: "center" });

                currentY += 12;

                // Invoice No and Date rows
                const rowHeight = 12;
                const subWidth30 = width60 * 0.3;

                // Invoice No row
                pdf.setTextColor(0, 0, 0); // Black text
                pdf.rect(margin, currentY, width60, rowHeight);
                pdf.rect(margin, currentY, subWidth30, rowHeight);
                pdf.text("Invoice No:", margin + 2, currentY + 8);
                pdf.text(invoiceNo, margin + subWidth30 + 2, currentY + 8);

                currentY += rowHeight;

                // Date row
                pdf.rect(margin, currentY, width60, rowHeight);
                pdf.rect(margin, currentY, subWidth30, rowHeight);
                pdf.text("Date:", margin + 2, currentY + 8);
                pdf.text(date, margin + subWidth30 + 2, currentY + 8);

                currentY += rowHeight;

                // Customer Name row
                pdf.rect(margin, currentY, width60, 47);
                pdf.text("Customer Name:", margin + 2, currentY + 8);
                pdf.setFontSize(14);
                pdf.text(customerName, margin + width60 / 2, currentY + 24, { align: "center" });

                currentY += 47;

                // Table Section
                // Table Section
                const headerXPositions = [margin, margin + 50, pageWidth - margin - 40];
                const headerWidths = [50, pageWidth - 2 * margin - 90, 40];

                // Center helper function
                const centerText = (pdf, text, x, width) => {
                    const textWidth = pdf.getTextWidth(text);
                    const xOffset = x + (width - textWidth) / 2;
                    return xOffset;
                };

                // Table Headers
                headerXPositions.forEach((xPos, index) => {
                    const width = headerWidths[index];
                    pdf.rect(xPos, currentY, width, 10); // Draw the header cell
                });
                pdf.text("S/N", margin + 25, currentY + 6, { align: "center" });
                pdf.text("Description", margin + 50 + (pageWidth - 2 * margin - 90) / 2, currentY + 6, { align: "center" });
                pdf.text("Amount", pageWidth - margin - 20, currentY + 6, { align: "center" });

                currentY += 10;

                // Table Data
                const rows = document.querySelectorAll('#itemTable tbody tr');
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const cellData = [
                        String(index + 1), // S/N
                        cells[1]?.querySelector('input')?.value || "N/A", // Description
                        cells[2]?.querySelector('input')?.value || "0.00", // Amount
                    ];

                    // Calculate required row height based on the longest cell
                    const padding = 5; // 5px padding
                    const lineHeight = 7; // Increased line height for better readability
                    const cellWidths = [50, pageWidth - 2 * margin - 90, 40]; // Widths for S/N, Description, Amount
                    const maxLines = cellData.map((data, i) => {
                        const textWidth = pdf.getTextWidth(data);
                        return Math.ceil(textWidth / (cellWidths[i] - padding * 2)); // Lines needed for the cell
                    });
                    const rowHeight = Math.max(...maxLines) * lineHeight + padding * 2; // Height based on the tallest cell

                    const yStart = currentY;

                    // Draw cell borders
                    pdf.rect(margin, yStart, 50, rowHeight); // S/N
                    pdf.rect(margin + 50, yStart, pageWidth - 2 * margin - 90, rowHeight); // Description
                    pdf.rect(pageWidth - margin - 40, yStart, 40, rowHeight); // Amount

                    // Add text with padding and handle multiline, center-aligned
                    cellData.forEach((data, i) => {
                        const xPos = [margin, margin + 50, pageWidth - margin - 40][i];
                        const cellWidth = cellWidths[i];
                        const lines = pdf.splitTextToSize(data, cellWidth - padding * 2);
                        const totalTextHeight = lines.length * lineHeight;
                        const startY = yStart + (rowHeight - totalTextHeight) / 2 + padding; // Center text vertically

                        lines.forEach((line, lineIndex) => {
                            const textX = xPos + cellWidth / 2; // Center alignment horizontally
                            const textY = startY + lineIndex * lineHeight; // Line height
                            pdf.text(line, textX, textY, { align: "center" });
                        });
                    });

                    currentY += rowHeight; // Move to the next row
                });


                pdf.save('bill.pdf');
            }




            // Retrieve the customer name from an input field and generate the PDF



        </script>
        <script>
            // Date Field Functionality
            const dateField = document.getElementById('dateField');

            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            };

            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            };

            const today = new Date();
            dateField.value = formatDate(today);

            dateField.addEventListener('click', () => {
                dateField.removeAttribute('readonly');

                const datePicker = document.createElement('input');
                datePicker.type = 'date';
                datePicker.style.position = 'absolute';
                datePicker.style.visibility = 'hidden';
                document.body.appendChild(datePicker);

                const currentDate = parseDate(dateField.value);
                datePicker.value = currentDate.toISOString().split('T')[0];

                datePicker.addEventListener('change', () => {
                    const selectedDate = new Date(datePicker.value);
                    dateField.value = formatDate(selectedDate);
                    document.body.removeChild(datePicker);
                });

                datePicker.addEventListener('blur', () => {
                    document.body.removeChild(datePicker);
                });

                datePicker.click();
            });

            dateField.addEventListener('blur', () => {
                if (!dateField.value) {
                    dateField.value = formatDate(today);
                }
                dateField.setAttribute('readonly', true);
            });

            // Table Functionality
            const itemTable = document.getElementById('itemTable').querySelector('tbody');
            let rowCount = 0;

            // Add a new row to the table
            const addRow = () => {
                rowCount++;
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${rowCount}</td>
            <td><input type="text" class="item-name" placeholder="Item Name"></td>
            <td><input type="number" class="amount-input" value="0" min="0" step="0.01"></td>
            <td><span class="delete-btn" onclick="deleteRow(this)">
                <img src="./icons/cross.png" width="15px" alt="">
            </span></td>
        `;
                itemTable.appendChild(row);
                toggleDeleteButtonsVisibility();
            };

            const toggleDeleteButtonsVisibility = () => {
                const deleteButtons = document.querySelectorAll('.delete-btn');
                const shouldShow = rowCount > 1; // Show delete buttons only if there are multiple rows
                deleteButtons.forEach(button => {
                    button.style.display = shouldShow ? 'inline-block' : 'none';
                });
            };

            // Check if the last row is completely filled
            const checkAndAddRow = () => {
                const rows = itemTable.querySelectorAll('tr');
                const lastRow = rows[rows.length - 1];
                const itemName = lastRow.querySelector('.item-name').value.trim();
                const amount = lastRow.querySelector('.amount-input').value.trim();

                if (itemName && amount) {
                    addRow(); // Add a new row if the current row is completely filled
                }
            };

            // Delete a row
            const deleteRow = (button) => {
                const row = button.closest('tr');
                itemTable.removeChild(row);
                rowCount--;
                toggleDeleteButtonsVisibility();
                updateSerialNumbers();
                calculateTotalAmount();
            };

            // Update serial numbers after deleting a row
            const updateSerialNumbers = () => {
                rowCount = 0;
                const rows = itemTable.querySelectorAll('tr');
                rows.forEach(row => {
                    rowCount++;
                    row.querySelector('td:first-child').textContent = rowCount;
                });
            };

            // Calculate total amount
            const calculateTotalAmount = () => {
                const amounts = document.querySelectorAll('.amount-input');
                let sum = 0;
                amounts.forEach(input => {
                    sum += parseFloat(input.value) || 0;
                });

                document.getElementById('total').textContent = sum.toFixed(2);
                document.getElementById('credtotal').textContent = sum.toFixed(2);
                updateBalance();
            };

            const initialPaymentInput = document.getElementById('initialPayment');
            const balanceAmountSpan = document.getElementById('balanceAmount');

            // Update balance based on total amount and initial payment
            const updateBalance = () => {
                const totalAmount = parseFloat(document.getElementById('total').textContent) || 0;
                const initialPayment = parseFloat(initialPaymentInput.value) || 0;
                const balance = totalAmount - initialPayment;
                balanceAmountSpan.textContent = balance.toFixed(2);
            };

            initialPaymentInput.addEventListener('input', () => {
                const totalAmount = parseFloat(document.getElementById('total').textContent) || 0;
                const initialPayment = parseFloat(initialPaymentInput.value) || 0;

                if (initialPayment > totalAmount) {
                    initialPaymentInput.value = totalAmount;
                }
                updateBalance();
            });

            // Add event listener to check and add a new row when inputs change
            itemTable.addEventListener('input', (e) => {
                if (e.target.classList.contains('item-name') || e.target.classList.contains('amount-input')) {
                    checkAndAddRow(); // Check and add a new row if needed
                    calculateTotalAmount(); // Recalculate the total amount
                }
            });

            // Add the initial row on page load
            window.onload = () => {
                // window.pdfload();
                addRow();
            };
        </script>



</body>

</html>